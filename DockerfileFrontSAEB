# Estágio de build
FROM node:20-alpine AS build

WORKDIR /app

# Copiar package files e instalar dependências
# Isso aproveita o cache do Docker para dependências
COPY package*.json ./
RUN npm install

# Copiar o restante do código fonte
COPY . .

# Adicionar permissão de execução explicitamente para o Vite e então executar o build.
# O output do build será na pasta 'build' conforme seu vite.config.mts.
RUN chmod +x ./node_modules/.bin/vite && ./node_modules/.bin/vite build

# Production stage
FROM node:20-alpine

WORKDIR /app

# COPIAR DA PASTA 'build', NÃO 'dist'! <-- MUDANÇA AQUI
COPY --from=build /app/build ./build 
# Copia os arquivos buildados da pasta 'build'
# Adicionado: Copiar package.json para o stage de produção
COPY --from=build /app/package*.json ./

# Instalar 'serve' globalmente para usá-lo como um servidor de arquivos estáticos
RUN npm install -g serve

# O Railway injetará a variável de ambiente $PORT em tempo de execução.
EXPOSE $PORT

# Comando para iniciar o servidor de arquivos estáticos
# Agora o 'serve' deve apontar para a pasta 'build'. <-- MUDANÇA AQUI
CMD ["serve", "-s", "build", "-p", "$PORT"]