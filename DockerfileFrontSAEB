# Estágio de build
FROM node:20-alpine AS build

WORKDIR /app

# Copiar package files e instalar dependências
# Isso aproveita o cache do Docker para dependências
COPY package*.json ./
RUN npm install

# Copiar o restante do código fonte
COPY . .

# Adicionar permissão de execução explicitamente para o Vite
# Isso é crucial para evitar o erro "Permission denied"
RUN chmod +x ./node_modules/.bin/vite

# Executar o build do Vite
# O output do build será na pasta 'build' conforme seu vite.config.mts.
RUN npm run build

# Production stage
FROM node:20-alpine

WORKDIR /app

# Copia os arquivos buildados da pasta 'build' do estágio anterior
COPY --from=build /app/build ./build 

# Instalar 'serve' globalmente para usá-lo como um servidor de arquivos estáticos
RUN npm install -g serve

# O Railway injetará a variável de ambiente $PORT em tempo de execução.
# EXPOSE não é estritamente necessário para o Railway, mas é boa prática
EXPOSE 3000 # ou a porta que você espera, mas o $PORT do Railway irá sobrescrever

# Comando para iniciar o servidor de arquivos estáticos
# CRUCIAL: Apenas passar '-l $PORT' ou '-p $PORT'
CMD sh -c "serve -s build -p $PORT"