# Build stage
FROM node:20-alpine AS build

WORKDIR /app

# Copiar package files
COPY package*.json ./

# Instalar dependências
RUN npm install

# Copiar código fonte
COPY . .

# Adicionar permissão de execução explicitamente para o Vite antes de construir
# E então executar o build
RUN chmod +x ./node_modules/.bin/vite && vite build

# Production stage
FROM node:20-alpine

WORKDIR /app

# Copiar arquivos buildados
COPY --from=build /app/dist ./dist
COPY --from=build /app/package*.json ./

# Instalar apenas serve
RUN npm install -g serve

# Adicionar permissão de execução explicitamente para o Vite antes de construir
# E então executar o build
RUN chmod +x ./node_modules/.bin/vite && vite build

# Comando para iniciar o servidor de arquivos estáticos
# O Railway passará $PORT para este comando
CMD ["serve", "-s", "dist", "-p", "$PORT"]